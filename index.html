<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ramazon Tasbihi Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #042c2c;
            --secondary: #0f5254;
            --accent: #d4af37; /* Gold */
            --accent-glow: rgba(212, 175, 55, 0.6);
            --danger: #ef4444;
            --danger-glow: rgba(239, 68, 68, 0.4);
            --text-white: #ffffff;
            --text-muted: #a7f3d0;
            --glass: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.15);
            --nav-height: 70px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Inter', sans-serif;
            background: radial-gradient(circle at top left, #115e60, #042c2c);
            color: var(--text-white);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Background Elements */
        .bg-glow {
            position: absolute;
            width: 350px;
            height: 350px;
            background: var(--accent);
            filter: blur(160px);
            border-radius: 50%;
            opacity: 0.15;
            top: -100px;
            left: -101px;
            z-index: 0;
            animation: float 10s infinite alternate;
        }
        .bg-glow-2 {
            position: absolute;
            width: 300px;
            height: 300px;
            background: #0ea5e9;
            filter: blur(140px);
            border-radius: 50%;
            opacity: 0.12;
            bottom: -50px;
            right: -50px;
            z-index: 0;
            animation: float 14s infinite alternate-reverse;
        }

        @keyframes float { 0% { transform: translate(0,0); } 100% { transform: translate(30px, 30px); } }

        /* Layout */
        .app-content {
            flex: 1;
            position: relative;
            overflow: hidden;
            z-index: 1;
            padding-bottom: var(--nav-height);
        }

        .page {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            overflow-y: auto;
            padding: 20px;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
            pointer-events: none;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .page.active {
            opacity: 1;
            transform: translateY(0);
            pointer-events: all;
        }

        /* --- PAGE 1: COUNTER --- */
        .header { text-align: center; margin-bottom: 25px; width: 100%; position: relative; z-index: 2; }
        .header h1 { font-family: 'Amiri', serif; font-size: 2.2rem; color: var(--accent); text-shadow: 0 4px 15px rgba(0,0,0,0.4); margin-bottom: 8px; }
        
        .rank-pill {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(212, 175, 55, 0.1);
            border: 1px solid rgba(212, 175, 55, 0.3);
            padding: 8px 20px;
            border-radius: 30px;
            font-size: 0.9rem;
            color: var(--accent);
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
        }

        .dhikr-selector {
            width: 100%;
            max-width: 300px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--glass-border);
            padding: 15px;
            border-radius: 16px;
            color: white;
            font-family: 'Amiri', serif;
            font-size: 1.2rem;
            text-align: center;
            margin-bottom: 30px;
            backdrop-filter: blur(12px);
            outline: none;
            appearance: none;
            cursor: pointer;
            transition: 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .dhikr-selector:hover { background: rgba(0,0,0,0.5); border-color: var(--accent); }

        .counter-container {
            position: relative;
            width: 280px;
            height: 280px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 40px;
        }

        .ring-svg { position: absolute; transform: rotate(-90deg); width: 100%; height: 100%; filter: drop-shadow(0 0 5px rgba(0,0,0,0.3)); }
        .ring-bg { stroke: rgba(255,255,255,0.05); stroke-width: 12; fill: transparent; }
        .ring-progress { 
            stroke: var(--accent); 
            stroke-width: 12; 
            fill: transparent; 
            stroke-linecap: round;
            transition: stroke-dashoffset 0.4s ease;
            filter: drop-shadow(0 0 8px var(--accent-glow));
        }

        .counter-btn {
            width: 220px;
            height: 220px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #1a7a7d, #053538);
            box-shadow: 
                0 20px 50px rgba(0,0,0,0.6),
                inset 0 5px 20px rgba(255,255,255,0.1),
                inset 0 -10px 20px rgba(0,0,0,0.5);
            border: 2px solid rgba(255,255,255,0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.1s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.3s;
            position: relative;
            z-index: 2;
        }

        .counter-btn:active { transform: scale(0.94); box-shadow: 0 10px 20px rgba(0,0,0,0.5); }
        .counter-btn:hover { box-shadow: 0 25px 60px rgba(0,0,0,0.7); }

        .count-num { font-size: 4.8rem; font-weight: 700; color: #fff; font-family: 'Amiri', serif; line-height: 1; text-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        .target-label { font-size: 0.85rem; color: var(--text-muted); margin-top: 8px; text-transform: uppercase; letter-spacing: 1.5px; font-weight: 500; }

        /* CONTROLS ROW - REVISED */
        .controls-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-top: 10px;
        }

        .circle-btn {
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            color: white;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            backdrop-filter: blur(10px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        /* Specific Button Sizes */
        .btn-lg { width: 65px; height: 65px; font-size: 1.8rem; }
        .btn-md { width: 55px; height: 55px; font-size: 1.4rem; }

        /* Hover & Active States */
        .circle-btn:hover { background: rgba(255,255,255,0.15); transform: translateY(-3px); }
        .circle-btn:active { transform: scale(0.95); }

        /* Audio Button Special Style */
        #audioBtn.active {
            background: var(--accent);
            color: #042c2c;
            border-color: var(--accent);
            box-shadow: 0 0 20px var(--accent-glow);
            animation: pulse-gold 2s infinite;
        }
        
        @keyframes pulse-gold {
            0% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(212, 175, 55, 0); }
            100% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0); }
        }

        /* Reset Button Special Style (Danger) */
        .btn-reset:hover {
            border-color: var(--danger);
            color: #fca5a5;
            box-shadow: 0 0 15px var(--danger-glow);
        }

        /* --- PAGE 2: HISTORY --- */
        .history-card {
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 15px;
            margin-bottom: 12px;
            width: 100%;
            max-width: 400px;
            backdrop-filter: blur(10px);
            transition: transform 0.2s;
        }
        .history-card:hover { transform: scale(1.01); background: rgba(0,0,0,0.4); }
        .history-date { color: var(--accent); font-family: 'Amiri'; font-size: 1.2rem; margin-bottom: 8px; display: flex; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 8px; }
        .history-item { display: flex; justify-content: space-between; color: var(--text-muted); font-size: 0.95rem; margin-top: 6px; }
        .history-item strong { color: white; font-weight: 600; }

        /* --- PAGE 3: PROFILE --- */
        .profile-header { text-align: center; margin-bottom: 30px; }
        .avatar {
            width: 110px; height: 110px;
            background: linear-gradient(135deg, var(--accent), #f59e0b);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 3.5rem;
            margin: 0 auto 20px;
            box-shadow: 0 0 40px var(--accent-glow);
            border: 4px solid rgba(255,255,255,0.15);
            animation: float 6s infinite ease-in-out;
        }
        .rank-title { font-size: 2rem; font-family: 'Amiri'; color: white; margin-bottom: 8px; }
        .rank-sub { color: var(--text-muted); font-size: 0.95rem; max-width: 250px; margin: 0 auto; line-height: 1.4; }

        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; max-width: 400px; }
        .stat-box {
            background: var(--glass); border: 1px solid var(--glass-border);
            padding: 20px; border-radius: 16px; text-align: center;
            backdrop-filter: blur(10px);
        }
        .stat-value { font-size: 1.8rem; font-weight: 700; color: var(--accent); text-shadow: 0 0 10px rgba(212, 175, 55, 0.3); }
        .stat-label { font-size: 0.85rem; color: var(--text-muted); margin-top: 5px; text-transform: uppercase; letter-spacing: 1px; }

        .next-rank {
            width: 100%; max-width: 400px; margin-top: 25px;
            background: rgba(0,0,0,0.3); padding: 20px; border-radius: 16px;
            border: 1px solid var(--glass-border);
        }
        .progress-bar-bg { height: 10px; background: rgba(255,255,255,0.1); border-radius: 5px; margin-top: 12px; overflow: hidden; }
        .progress-bar-fill { height: 100%; background: linear-gradient(90deg, var(--accent), #fff); width: 0%; transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 0 10px var(--accent); }

        /* BOTTOM NAV */
        .bottom-nav {
            position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%);
            width: 92%; max-width: 400px; height: 70px;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(25px);
            border: 1px solid var(--glass-border);
            border-radius: 40px;
            display: flex; justify-content: space-around; align-items: center;
            z-index: 100;
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
        }

        .nav-item {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: var(--text-muted); font-size: 0.7rem; font-weight: 500;
            cursor: pointer; width: 65px; height: 65px; border-radius: 50%; transition: 0.3s;
        }
        .nav-item span { font-size: 1.5rem; margin-bottom: 4px; transition: 0.3s; }
        .nav-item.active { color: var(--accent); background: rgba(255,255,255,0.05); transform: translateY(-8px); }
        .nav-item.active span { transform: scale(1.2); filter: drop-shadow(0 0 5px var(--accent-glow)); }

        /* MODAL (Settings) - REVISED */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 200;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: 0.3s;
            backdrop-filter: blur(8px);
        }
        .modal.open { opacity: 1; pointer-events: all; }
        .modal-content {
            background: linear-gradient(145deg, #134346, #092224);
            width: 90%; max-width: 340px;
            padding: 30px; border-radius: 24px;
            border: 1px solid var(--accent);
            text-align: center;
            transform: scale(0.8); transition: 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 0 30px rgba(0,0,0,0.6), inset 0 0 20px rgba(255,255,255,0.05);
        }
        .modal.open .modal-content { transform: scale(1); }
        .modal h3 { font-family: 'Amiri'; color: var(--accent); margin-bottom: 20px; font-size: 1.5rem; }
        .modal input {
            width: 100%; padding: 15px; background: rgba(0,0,0,0.3);
            border: 2px solid rgba(255,255,255,0.1); color: white;
            border-radius: 12px; text-align: center; font-size: 1.4rem; 
            margin-bottom: 25px; font-family: 'Amiri'; font-weight: bold;
            outline: none; transition: 0.3s;
        }
        .modal input:focus { border-color: var(--accent); box-shadow: 0 0 15px rgba(212, 175, 55, 0.3); }
        
        .modal-btns { display: flex; gap: 15px; }
        .btn { flex: 1; padding: 14px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; font-size: 1rem; transition: 0.2s; }
        .btn-primary { background: var(--accent); color: #042c2c; box-shadow: 0 4px 15px var(--accent-glow); }
        .btn-primary:active { transform: scale(0.96); }
        .btn-ghost { background: transparent; color: var(--text-muted); border: 1px solid var(--glass-border); }
        .btn-ghost:hover { background: rgba(255,255,255,0.05); color: white; }

        /* Toast Notification */
        .toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100%);
            background: rgba(4, 44, 44, 0.95);
            border: 1px solid var(--accent);
            color: var(--accent);
            padding: 12px 24px;
            border-radius: 50px;
            font-weight: 600;
            z-index: 300;
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            box-shadow: 0 5px 20px rgba(0,0,0,0.4);
            white-space: nowrap;
        }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

        /* PARTICLE */
        .particle { position: absolute; background: var(--accent); width: 8px; height: 8px; border-radius: 50%; pointer-events: none; z-index: 999; }

    </style>
</head>
    
<body>
    <div class="bg-glow"></div>
    <div class="bg-glow-2"></div>

    <!-- Toast Notification -->
    <div id="toast" class="toast">Saqlandi ‚úÖ</div>

    <div class="app-content">
        
        <!-- COUNTER PAGE -->
        <div id="page-counter" class="page active">
            <div class="header">
                <h1>Ramazon Karim</h1>
                <div class="rank-pill" id="miniRank">
                    <span id="miniRankIcon">üå±</span>
                    <span id="miniRankTitle">Boshlang'ich</span>
                </div>
            </div>

            <select id="dhikrSelect" class="dhikr-selector" onchange="changeDhikr()">
                <option value="salovat">Salavot</option>
                <option value="astagfiru">Astagfirulloh</option>
                <option value="subhanallah">Subhanalloh</option>
                <option value="alhamdulillah">Alhamdulillah</option>
                <option value="allahuakbar">Allohu Akbar</option>
                <option value="la_ilaha">La ilaha illalloh</option>
            </select>

            <div class="counter-container">
                <svg class="ring-svg" viewBox="0 0 100 100">
                    <circle class="ring-bg" cx="50" cy="50" r="45"></circle>
                    <circle class="ring-progress" id="progressRing" cx="50" cy="50" r="45"></circle>
                </svg>
                <button class="counter-btn" id="countBtn">
                    <span class="count-num" id="countDisplay">0</span>
                    <span class="target-label" id="targetLabel">33 / 33</span>
                </button>
            </div>

            <!-- REVISED CONTROLS -->
            <div class="controls-wrapper">
                <button class="circle-btn btn-reset btn-md" id="resetBtn" onclick="resetCurrent()" title="Qayta boshlash">
                    ‚Ü∫
                </button>
                
                <button class="circle-btn btn-md" onclick="openSettings()" title="Maqsadni o'zgartirish">
                    ‚öôÔ∏è
                </button>

                <button class="circle-btn btn-lg" id="audioBtn" onclick="toggleAudio()" title="Ovozni yoqish/o'chirish">
                    üîá
                </button>
            </div>
        </div>

        <!-- HISTORY PAGE -->
        <div id="page-history" class="page">
            <div class="header">
                <h1>Tarix</h1>
            </div>
            <div id="historyList" style="width: 100%; display: flex; flex-direction: column; align-items: center;"></div>
            <button class="btn btn-ghost" style="margin-top: 30px; width: 100%; max-width: 400px; border-color: var(--danger); color: var(--danger);" onclick="clearAllHistory()">Tarixni to'liq o'chirish</button>
        </div>

        <!-- PROFILE PAGE -->
        <div id="page-profile" class="page">
            <div class="header">
                <h1>Profil va Reyting</h1>
            </div>
            <div class="profile-header">
                <div class="avatar" id="rankAvatar">üå±</div>
                <h2 class="rank-title" id="rankTitle">Boshlang'ich</h2>
                <p class="rank-sub" id="rankDesc">Iymon yo'lida birinchi qadamlar</p>
            </div>

            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-value" id="totalGlobalCount">0</div>
                    <div class="stat-label">Jami Zikr</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="daysActive">1</div>
                    <div class="stat-label">Faol Kun</div>
                </div>
            </div>

            <div class="next-rank">
                <div style="display:flex; justify-content:space-between; font-size: 0.95rem; color: var(--text-muted); font-weight: 500;">
                    <span>Keyingi daraja</span>
                    <span id="nextRankName" style="color: white;">Taqvo (100)</span>
                </div>
                <div class="progress-bar-bg">
                    <div class="progress-bar-fill" id="rankProgress"></div>
                </div>
            </div>
            
            <button class="btn btn-ghost" style="margin-top: 40px; border-color: rgba(220,38,38,0.3); color: #fca5a5; width: 100%; max-width: 400px;" onclick="resetProgress()">Barcha ma'lumotlarni o'chirish</button>
        </div>

    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('counter')">
            <span>üìø</span>
            Tasbih
        </div>
        <div class="nav-item" onclick="switchTab('history')">
            <span>üìÖ</span>
            Tarix
        </div>
        <div class="nav-item" onclick="switchTab('profile')">
            <span>üë§</span>
            Profil
        </div>
    </nav>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <h3>Maqsadni belgilash</h3>
            <input type="number" id="targetInput" min="1" value="33">
            <div class="modal-btns">
                <button class="btn btn-ghost" onclick="closeSettings()">Bekor qilish</button>
                <button class="btn btn-primary" onclick="saveSettings()">Saqlash</button>
            </div>
        </div>
    </div>

    <script>
        // --- DATA & CONFIG ---
        const DHIKR_NAMES = {
            "salovat": "Salavot", "astagfiru": "Astagfirulloh", "subhanallah": "Subhanalloh",
            "alhamdulillah": "Alhamdulillah", "allahuakbar": "Allohu Akbar", "la_ilaha": "La ilaha illalloh"
        };
        const ARABIC_TEXT = {
            "salovat": "ÿµŸéŸÑŸéŸëŸâŸ∞ Ÿ±ŸÑŸÑŸéŸëŸ∞ŸáŸè ÿπŸéŸÑŸéŸäŸíŸáŸê ŸàŸéÿ≥ŸéŸÑŸéŸëŸÖŸé", "astagfiru": "ÿ£Ÿéÿ≥Ÿíÿ™Ÿéÿ∫ŸíŸÅŸêÿ±Ÿè Ÿ±ŸÑŸÑŸéŸëŸ∞ŸáŸé",
            "subhanallah": "ÿ≥Ÿèÿ®Ÿíÿ≠ŸéÿßŸÜŸé Ÿ±ŸÑŸÑŸéŸëŸ∞ŸáŸê", "alhamdulillah": "Ÿ±ŸÑŸíÿ≠ŸéŸÖŸíÿØŸè ŸÑŸêŸÑŸéŸëŸ∞ŸáŸê",
            "allahuakbar": "Ÿ±ŸÑŸÑŸéŸëŸ∞ŸáŸè ÿ£ŸéŸÉŸíÿ®Ÿéÿ±Ÿè", "la_ilaha": "ŸÑŸéÿß ÿ•ŸêŸÑŸ∞ŸáŸé ÿ•ŸêŸÑŸéŸëÿß Ÿ±ŸÑŸÑŸéŸëŸ∞ŸáŸè"
        };

        const RANKS = [
            { name: "Boshlang'ich", limit: 100, icon: "üå±", desc: "Iymon yo'lida birinchi qadamlar" },
            { name: "Taqvo", limit: 500, icon: "üïå", desc: "Doimiy zikr zodasi" },
            { name: "Mumin", limit: 2000, icon: "üíé", desc: "Ishonchli va sodiq banda" },
            { name: "Siddiq", limit: 5000, icon: "üåü", desc: "Haqiqat izdoshi" },
            { name: "Voliy", limit: 15000, icon: "üëë", desc: "Allohning sevimli quli" },
            { name: "Qari", limit: 50000, icon: "üìñ", desc: "Donishmand va bilimdon" }
        ];

        let db = JSON.parse(localStorage.getItem('ramadan_pro_db')) || {};
        let targets = JSON.parse(localStorage.getItem('ramadan_pro_targets')) || { "salovat": 33, "default": 33 };
        let settings = JSON.parse(localStorage.getItem('ramadan_pro_settings')) || { audio: false };
        let currentDhikr = localStorage.getItem('current_dhikr') || 'salovat';
        let todayStr = new Date().toISOString().split('T')[0];

        // --- ELEMENTS ---
        const els = {
            count: document.getElementById('countDisplay'),
            target: document.getElementById('targetLabel'),
            ring: document.getElementById('progressRing'),
            btn: document.getElementById('countBtn'),
            audioBtn: document.getElementById('audioBtn'),
            history: document.getElementById('historyList'),
            miniRankIcon: document.getElementById('miniRankIcon'),
            miniRankTitle: document.getElementById('miniRankTitle'),
            rankAvatar: document.getElementById('rankAvatar'),
            rankTitle: document.getElementById('rankTitle'),
            rankDesc: document.getElementById('rankDesc'),
            totalGlobal: document.getElementById('totalGlobalCount'),
            daysActive: document.getElementById('daysActive'),
            nextRankName: document.getElementById('nextRankName'),
            rankProgress: document.getElementById('rankProgress'),
            toast: document.getElementById('toast')
        };

        // Ring Setup
        const radius = els.ring.r.baseVal.value;
        const circumference = radius * 2 * Math.PI;
        els.ring.style.strokeDasharray = `${circumference} ${circumference}`;
        els.ring.style.strokeDashoffset = circumference;

        // --- CORE FUNCTIONS ---
        
        function getTodayData() {
            if (!db[todayStr]) db[todayStr] = {};
            Object.keys(DHIKR_NAMES).forEach(k => { if(db[todayStr][k] === undefined) db[todayStr][k] = 0; });
            return db[todayStr];
        }

        function getTotalGlobal() {
            let total = 0;
            Object.values(db).forEach(day => {
                Object.values(day).forEach(val => total += val);
            });
            return total;
        }

        function getRank(count) {
            for (let i = RANKS.length - 1; i >= 0; i--) {
                if (count >= RANKS[i].limit) return RANKS[i];
            }
            return { ...RANKS[0], name: "Salovat", limit: 100, icon: "üìø", desc: "Boshlash" };
        }

        function updateUI() {
            const today = getTodayData();
            const count = today[currentDhikr];
            const target = targets[currentDhikr] || 33;
            
            els.count.innerText = count;
            els.target.innerText = `${count} / ${target}`;
            
            // Ring Progress
            const pct = Math.min((count / target) * 100, 100);
            els.ring.style.strokeDashoffset = circumference - (pct / 100) * circumference;
            
            // Audio Button Visuals
            els.audioBtn.innerHTML = settings.audio ? 'üîä' : 'üîá';
            if (settings.audio) {
                els.audioBtn.classList.add('active');
            } else {
                els.audioBtn.classList.remove('active');
            }

            // Rank UI
            const globalTotal = getTotalGlobal();
            const currentRank = getRank(globalTotal);
            const nextRankIndex = RANKS.findIndex(r => r.name === currentRank.name) + 1;
            const nextRank = RANKS[nextRankIndex] || null;

            els.miniRankIcon.innerText = currentRank.icon;
            els.miniRankTitle.innerText = currentRank.name;

            els.rankAvatar.innerText = currentRank.icon;
            els.rankTitle.innerText = currentRank.name;
            els.rankDesc.innerText = currentRank.desc;
            els.totalGlobal.innerText = globalTotal;
            els.daysActive.innerText = Object.keys(db).length;

            if (nextRank) {
                els.nextRankName.innerText = `${nextRank.name} (${nextRank.limit})`;
                const progressPct = ((globalTotal - currentRank.limit) / (nextRank.limit - currentRank.limit)) * 100;
                els.rankProgress.style.width = `${Math.min(Math.max(progressPct, 0), 100)}%`;
            } else {
                els.nextRankName.innerText = "Maksimal daraja";
                els.rankProgress.style.width = '100%';
            }
        }

        function increment() {
            const today = getTodayData();
            const target = targets[currentDhikr] || 33;
            
            today[currentDhikr]++;
            saveData();
            updateUI();

            // Audio & Vibration
            if (settings.audio) speak(ARABIC_TEXT[currentDhikr]);
            if (navigator.vibrate) navigator.vibrate(30);

            // Target Reached Check
            if (today[currentDhikr] % target === 0 && today[currentDhikr] > 0) {
                createConfetti();
                if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
                els.btn.style.transform = "scale(1.05)";
                setTimeout(() => els.btn.style.transform = "", 200);
            }
        }

        function saveData() {
            localStorage.setItem('ramadan_pro_db', JSON.stringify(db));
            localStorage.setItem('ramadan_pro_targets', JSON.stringify(targets));
            localStorage.setItem('ramadan_pro_settings', JSON.stringify(settings));
            localStorage.setItem('current_dhikr', currentDhikr);
        }

        // --- AUDIO ---
        function speak(text) {
            if (!('speechSynthesis' in window)) return;
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'ar-SA';
            u.rate = 0.8; u.pitch = 0.8;
            window.speechSynthesis.speak(u);
        }

        function toggleAudio() {
            settings.audio = !settings.audio;
            saveData();
            updateUI();
            // Feedback toast
            showToast(settings.audio ? "Ovoz yoqildi üîä" : "Ovoz o'chirildi üîá");
        }

        // --- TOAST NOTIFICATION ---
        function showToast(message) {
            els.toast.innerText = message;
            els.toast.classList.add('show');
            setTimeout(() => els.toast.classList.remove('show'), 2000);
        }

        // --- TABS & NAVIGATION ---
        function switchTab(tabId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(`page-${tabId}`).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            const index = ['counter', 'history', 'profile'].indexOf(tabId);
            document.querySelectorAll('.nav-item')[index].classList.add('active');

            if (tabId === 'history') renderHistory();
            if (tabId === 'profile') updateUI();
        }

        function changeDhikr() {
            currentDhikr = document.getElementById('dhikrSelect').value;
            updateUI();
        }

        function resetCurrent() {
            // Double confirmation via UI logic or just clear
            const today = getTodayData();
            today[currentDhikr] = 0;
            saveData(); updateUI();
            showToast("Sanovgich qayta o'rnatildi ‚Ü∫");
        }

        // --- HISTORY ---
        function renderHistory() {
            els.history.innerHTML = '';
            const dates = Object.keys(db).sort().reverse();
            if(dates.length === 0) { els.history.innerHTML = '<p style="color:var(--text-muted); margin-top:20px;">Hali tarix yo\'q</p>'; return; }

            dates.forEach(date => {
                const data = db[date];
                const dObj = new Date(date);
                const fmt = dObj.toLocaleDateString('uz-UZ', { day: 'numeric', month: 'long' });
                
                let html = `<div class="history-card"><div class="history-date"><span>${fmt}</span> <span style="font-size:0.8rem; opacity:0.6">${date}</span></div>`;
                let hasData = false;
                Object.keys(data).forEach(k => {
                    if(data[k] > 0) {
                        hasData = true;
                        html += `<div class="history-item"><span>${DHIKR_NAMES[k]}</span><strong>${data[k]}</strong></div>`;
                    }
                });
                html += `</div>`;
                if(hasData) els.history.innerHTML += html;
            });
        }

        function clearAllHistory() {
            if(confirm("Haqiqatan ham barcha tarixni o'chirmoqchimisiz? Bu amalni ortga qaytarib bo'lmaydi.")) {
                db = {}; saveData(); renderHistory();
                showToast("Tarix tozalandi üóëÔ∏è");
            }
        }

        // --- SETTINGS MODAL ---
        const modal = document.getElementById('settingsModal');
        const targetInput = document.getElementById('targetInput');
        
        function openSettings() { 
            targetInput.value = targets[currentDhikr] || 33; 
            modal.classList.add('open'); 
            setTimeout(() => targetInput.focus(), 100);
        }
        function closeSettings() { modal.classList.remove('open'); }
        
        function saveSettings() {
            const val = parseInt(targetInput.value);
            if(val > 0) {
                targets[currentDhikr] = val;
                saveData(); updateUI(); closeSettings();
                showToast(`Maqsad ${val} ga o'zgartirildi üéØ`);
            } else {
                targetInput.style.borderColor = 'red';
                setTimeout(()=>targetInput.style.borderColor = 'rgba(255,255,255,0.1)', 500);
            }
        }

        function resetProgress() {
            if(confirm("DIQQAT! Sizning barcha yutuqlaringiz, darajangiz va tarixingiz o'chiriladi. Davom etasizmi?")) {
                localStorage.clear(); location.reload();
            }
        }

        // --- PARTICLES ---
        function createConfetti() {
            for (let i = 0; i < 40; i++) {
                const p = document.createElement('div');
                p.classList.add('particle');
                document.body.appendChild(p);
                
                const x = window.innerWidth / 2;
                const y = window.innerHeight / 2;
                
                p.style.left = x + 'px';
                p.style.top = y + 'px';
                // Gold and White colors
                p.style.backgroundColor = Math.random() > 0.3 ? '#d4af37' : '#ffffff';
                p.style.width = (Math.random() * 6 + 4) + 'px';
                p.style.height = p.style.width;

                const destX = (Math.random() - 0.5) * 400;
                const destY = (Math.random() - 0.5) * 400;
                const rot = Math.random() * 720;

                const anim = p.animate([
                    { transform: `translate(0,0) rotate(0)`, opacity: 1 },
                    { transform: `translate(${destX}px, ${destY}px) rotate(${rot}deg)`, opacity: 0 }
                ], {
                    duration: 1200 + Math.random() * 600,
                    easing: 'cubic-bezier(0, .9, .57, 1)',
                    delay: Math.random() * 100
                });

                anim.onfinish = () => p.remove();
            }
        }

        // --- INIT ---
        els.btn.addEventListener('click', increment);
        
        // Keyboard support
        document.addEventListener('keydown', e => {
            if((e.code === 'Space' || e.code === 'Enter') && !modal.classList.contains('open')) {
                e.preventDefault(); increment();
                els.btn.style.transform = "scale(0.95)";
                setTimeout(()=>els.btn.style.transform="", 100);
            }
            if(e.key === 'Escape') closeSettings();
        });

        updateUI();

    </script>
</body>

</html>

